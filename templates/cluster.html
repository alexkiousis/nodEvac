<!DOCTYPE html>
<html>
<head>
    <title>{{ cluster_name }} - nodEvac </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style>
        * {
                  border-radius: 0 !important;
        }
        .panel-body {    
                padding:0px;
        }
    </style>
</head>
<body>
<div class="container">

    <div class="panel panel-default">

        <div class="panel-heading">
           <a href="{{ url_for('index') }}">Go back</a>
           <h3 class="text-center">{{ cluster_name }}</h3>
           <dl class="dl-horizontal">
                     <dt>Number of Nodes:</dt>
                     <dd>{{ cluster_info.nodes | length }}</dd>

                     <dt>Ganeti Version:</dt>
                     <dd>{{ cluster_info.software_version}}</dd>

                     <dt>Disk Templates:</dt>
                     <dd>
                         {% for template in  cluster_info.enabled_disk_templates %} 
                             <span class="label label-info"> {{ template }} </span> 
                         {% endfor %}
                     </dd>

                     <dt>Enabled Hypervisor:</dt>
                     <dd>{{ cluster_info.enabled_hypervisors }}</dd>

                     <dt>Tags</dt>
                     <dd>
                         {% for tag in cluster_info.tags %} 
                        <span class="label label-info"> {{ tag }} </span> 
                        {% endfor %}
                     </dd>
           </dl>
            <button type="button" class="btn btn-default btn-lg btn-block">Rebalance Cluster</button>
        </div>  <!-- panel-heading -->

        <div class="panel-body" style="padding:0px;">

            <ul class="nav nav-tabs">
                <li class="active"><a href="#tab1default" data-toggle="tab">Nodes</a></li>
            </ul>

        <ul class="list-group">
        {% for node in cluster_info.nodes | sort %}
            <div class="list-group-item">
                <i class="fa fa-server" aria-hidden="true"></i>
                <a href="{{ url_for('ganeti_node_view', node_name=node.name, cluster_name=cluster_name )}}"> {{ node.name }} </a>
                <span class="badge pull-right">{{ node.pinst_cnt }}</span>
            </div>
        {% endfor %}
        </ul>

        </div>  <!-- panel-body -->

    </div> <!-- panel -->

    <script>
            function start_migration_task(instance_name, cluster_name) {
                // send ajax POST request to start background job
                $.ajax({
                    type: 'POST',
                    url: '/migrate',
                    data: { instance_name: instance_name, cluster_name: cluster_name },
                    success: function(data, status, request) {
                        status_url = request.getResponseHeader('Location');
                        console.log(status_url);
                        update_progress(status_url, $('#list_' + instance_name + '_progress'), $('#list_' + instance_name + '_item'));
                    },
                });
            }
            function update_progress(status_url, progressbar_element, status_div) {
                // send GET request to status URL to get current status of job
                $.getJSON(status_url, function(data) {
                    percent = parseInt(data['percent']);
                    progressbar_element.css('width', percent + '%');
                    progressbar_element.text(percent + '%');
                    if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
                        if ('result' in data) {
                            status_div.find("instance_migrate_status").text('Result: ' + data['state']);
                        } else {
                            status_div.find("instance_migrate_status").text('Result: ' + data['state']);
                        }
                    } else {
                        setTimeout(function() {
                            update_progress(status_url, progressbar_element, status_div);
                        }, 2000); // rerun in 2 seconds
                    }
                });
            };
    </script>

  </body>
</html>
